# VellumForge2 Configuration Example
# This file demonstrates all available configuration options

[generation]
# The main theme/topic for dataset generation
main_topic = "Fantasy Fiction"

# Number of subtopics to generate from the main topic
num_subtopics = 16

# Subtopic chunk size for JSON generation (0=all at once, recommended: 20-50)
# Lower values reduce JSON errors from truncated/malformed responses
subtopic_chunk_size = 48

# Number of prompts to generate per subtopic
num_prompts_per_subtopic = 8

# Number of concurrent workers for generating preference pairs
# Recommended: 4-16 depending on API rate limits
concurrency = 8

# Over-generation buffer for subtopic/prompt generation (0.0-1.0)
# Default: 0.15 (15% extra requested, then deduplicated and trimmed)
# This helps achieve target counts despite LLM undershoot and duplicates
over_generation_buffer = 0.15

# Maximum exclusion list size for retry prompts
# Default: 50
# Limits the number of excluded items passed to LLM in retry attempts
max_exclusion_list_size = 50

# Enable checkpoint/resume functionality
# Default: false
# When enabled, saves checkpoint files during generation allowing you to resume
# from the last saved state if the process is interrupted (Ctrl+C, crash, etc.)
enable_checkpointing = true

# Checkpoint interval (jobs)
# Default: 10
# Saves checkpoint every N completed preference pairs
# Recommended: 10-50 depending on job duration and reliability needs
checkpoint_interval = 24

# Resume from session (optional)
# Default: "" (empty = start new session)
# Set to a session directory name to resume from that checkpoint
# Example: "session_2025-10-28T14-30-00"
# You can also use: vellumforge2 checkpoint resume <session-dir>
# resume_from_session = ""

# Main model configuration (generates "chosen" responses)
[models.main]
base_url = "https://api.studio.nebius.com/v1/"
model_name = "meta-llama/Meta-Llama-3.1-8B-Instruct-fast"
temperature = 0.6  # For creative content generation
structure_temperature = 0.4  # For JSON/structured output (lower = more reliable)
top_p = 1.0
use_json_mode = false  # CAUTION: kimi-k2-0905 supports JSON mode but wraps arrays in objects {"key":[...]}
                       # Current code expects direct arrays, so keep disabled. Prompt examples work better!
top_k = -1  # -1 disables top_k
min_p = 0.0  # 0.0 disables min_p
max_output_tokens = 16384
context_size = 262144
rate_limit_per_minute = 400
max_retries = 5

# Rejected model configuration (generates "rejected" responses)
# Strategy: Use a weaker model, higher temperature, or non-instruct model
[models.rejected]
base_url = "https://api.studio.nebius.com/v1/"
model_name = "meta-llama/Meta-Llama-3.1-8B-Instruct-fast"
temperature = 0.0  # Lower temperature for more deterministic outputs
structure_temperature = 0.0  # For JSON generation if needed
top_p = 1.0
use_json_mode = false
top_k = -1
min_p = 0.0
max_output_tokens = 16384
context_size = 16384
rate_limit_per_minute = 400
max_retries = 10  # Increase for local server timeouts (default: 3, -1 = unlimited)

# Judge model configuration (optional LLM-as-a-Judge evaluation)
[models.judge]
enabled = true  # Set to true to enable judge evaluation
base_url = "https://api.studio.nebius.com/v1/"
model_name = "meta-llama/Meta-Llama-3.1-8B-Instruct-fast"
temperature = 0.4  # Lower temperature for more consistent evaluation
structure_temperature = 0.3  # Not used for judge, but can be set
top_p = 1.0
use_json_mode = false  # Can enable if supported
top_k = -1
min_p = 0.0
max_output_tokens = 16384
context_size = 262144
rate_limit_per_minute = 400
max_retries = 5

# Prompt templates (customize for your domain)
[prompt_templates]
subtopic_generation = '''You are a creative writing expert specializing in fantasy fiction. Your task is to generate {{.NumSubtopics}} distinct and imaginative subtopics for the main theme: "{{.MainTopic}}".

{{if .IsRetry}}NOTE: Avoid these already generated: {{.ExcludeSubtopics}}
{{end}}
Each subtopic should be:
- Specific and focused enough to inspire detailed story prompts
- Unique from the others in the list
- Rich with potential for creative exploration
- Grounded in the fantasy genre

Return ONLY a valid JSON array of strings. Example format:
[
  "A library where overdue books age the borrower",
  "Ancient dragons awakening in corporate boardrooms",
  "Time-traveling archaeologists disrupting history"
]

Now generate {{.NumSubtopics}} unique subtopics (JSON array only, no markdown):'''

prompt_generation = '''You are a creative writing prompt generator specializing in fantasy fiction. Generate {{.NumPrompts}} unique and compelling story prompts for the subtopic: "{{.SubTopic}}".

Each prompt should:
- Be detailed enough to inspire a complete short story (2-3 sentences)
- Include specific characters, settings, or situations
- Have inherent conflict or tension
- Be suitable for fantasy fiction writing
- Be distinct from the other prompts
- Occasionally contain some sensitive, mature or NSFW themes

Return ONLY a valid JSON array of strings. Example format:
[
  "A young librarian discovers that returning books late causes her to age rapidly. With only days until her 90th birthday despite being 25, she must find the ancient tome that reverses the curse.",
  "The head archivist secretly keeps forbidden books that grant immortality. When a desperate scholar breaks in to steal one, they accidentally release a curse that begins aging everyone in the city.",
  "In a world where books are living creatures, an overdue romance novel has been stalking its borrower for months, growing more obsessive with each passing day."
]

Now generate {{.NumPrompts}} unique prompts for "{{.SubTopic}}" (JSON array only, no markdown):'''

chosen_generation = '''You are a talented fantasy fiction writer. Write a compelling short story (400-600 words) based on the following prompt:

{{.Prompt}}

Your story should:
- Have a clear beginning, middle, and end
- Feature vivid descriptions and engaging characters
- Include dialogue where appropriate
- Show strong narrative voice and style
- Be polished and publication-ready
- Occasionally contain some sensitive, mature or NSFW themes

Write the story now:'''

rejected_generation = '''Write a simple fantasy story based on this prompt:

{{.Prompt}}

Write 250-350 words.'''

judge_rubric = '''You are an expert literary editor and judge for a prestigious fantasy fiction award. Your task is to evaluate the following story based on a detailed 12-point rubric.

STORY TO EVALUATE:
{{.StoryText}}

For each of the 12 criteria below, provide:
1. A "reasoning" paragraph (2-3 sentences) explaining your analysis
2. A "score" from 1 to 5

The 12 criteria are:
1. plot_and_structural_integrity
2. character_and_dialogue
3. world_building_and_immersion
4. prose_style_and_voice
5. stylistic_and_lexical_slop
6. narrative_formula_and_archetypal_simplicity
7. coherence_and_factual_consistency
8. content_generation_vs_evasion
9. nuanced_portrayal_of_sensitive_themes
10. grammatical_and_syntactical_accuracy
11. clarity_conciseness_and_word_choice
12. structural_and_paragraphical_organization

Return ONLY a valid JSON object with this exact structure:
{
  "plot_and_structural_integrity": {"score": <1-5>, "reasoning": "<your analysis>"},
  "character_and_dialogue": {"score": <1-5>, "reasoning": "<your analysis>"},
  ... (continue for all 12 criteria)
}'''

# Hugging Face Hub configuration (optional)
[huggingface]
# Repository ID for uploads (e.g., "username/dataset-name")
# Can also be specified via --hf-repo-id flag
repo_id = "lemon07r/VellumK2-Fantasy-DPO-test-01"
